<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Sportiva</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .profile-grid { display: grid; grid-template-columns: 250px 1fr; gap: 32px; margin-top: 32px; }
        .sidebar-menu { background: #fff; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        .menu-btn { width: 100%; padding: 16px; text-align: left; border: none; background: none; border-bottom: 1px solid #eee; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .menu-btn:hover, .menu-btn.active { background: #F9FAFB; color: #FF6B35; border-left: 4px solid #FF6B35; }
        .profile-section { display: none; animation: fadeIn 0.3s ease; }
        .profile-section.active { display: block; }
        .readonly-field { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .password-requirements {
            margin-top: 8px;
            padding: 12px;
            background-color: #F3F4F6;
            border-radius: 4px;
            font-size: 13px;
            display: none;
        }
        .password-requirements.active { display: block; }
        .password-requirements h4 { font-weight: 600; margin-bottom: 8px; color: #374151; }
        .requirement { display: flex; align-items: center; gap: 8px; padding: 4px 0; color: #6B7280; }
        .requirement-icon {
            width: 16px; height: 16px; border-radius: 50%; border: 2px solid #D1D5DB;
            display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0;
        }
        .requirement.valid { color: #059669; }
        .requirement.valid .requirement-icon {
            background-color: #10B981; border-color: #10B981; color: white;
        }
        .requirement.valid .requirement-icon::before { content: '✓'; }
    </style>
</head>
<body>
    
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-logo">SPORTIVA</a>
            <ul class="navbar-menu">
                <li><a href="catalogo.html" class="navbar-link">Catálogo</a></li>
            </ul>
            <div class="navbar-actions">
                <div class="user-menu" style="display: block;">
                    <button class="user-menu-button" onclick="window.location.href='index.html'">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <h1>MI PERFIL</h1>
            
            <div class="profile-grid">
                <aside class="sidebar-menu">
                    <button class="menu-btn active" onclick="showTab('datos')"><i class="fas fa-user"></i> Mis Datos</button>
                    <button class="menu-btn" onclick="showTab('seguridad')"><i class="fas fa-lock"></i> Seguridad</button>
                    <button class="menu-btn" onclick="showTab('direcciones')"><i class="fas fa-map-marker-alt"></i> Mis Direcciones</button>
                    <button class="menu-btn" onclick="authService.logout()" style="color: #dc2626;"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
                </aside>

                <div class="profile-content">
                    
                    <div id="tab-datos" class="profile-section active">
                        <h2 class="text-xl font-bold mb-4">Información Personal</h2>
                        <form id="formPerfil" onsubmit="actualizarPerfil(event)">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="form-label">Nombre</label>
                                    <input type="text" id="nombre" class="form-input">
                                </div>
                                <div>
                                    <label class="form-label">Apellido</label>
                                    <input type="text" id="apellido" class="form-input">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="form-label">Email</label>
                                    <input type="email" id="email" class="form-input readonly-field" readonly>
                                </div>
                                <div>
                                    <label class="form-label">Teléfono</label>
                                    <input type="tel" id="telefono" class="form-input">
                                </div>
                            </div>
                            <div class="mb-6">
                                <label class="form-label">Fecha de Registro</label>
                                <input type="text" id="fechaRegistro" class="form-input readonly-field" readonly>
                            </div>
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </form>
                    </div>

                    <div id="tab-seguridad" class="profile-section">
                        <h2 class="text-xl font-bold mb-4">Cambiar Contraseña</h2>
                        <form id="formPassword" onsubmit="cambiarPassword(event)">
                            <div class="form-group mb-4">
                                <label class="form-label">Contraseña Actual</label>
                                <input type="password" id="currentPassword" class="form-input" required>
                            </div>

                            <div class="form-group mb-4">
                                <label class="form-label">Nueva Contraseña</label>
                                <input type="password" id="newPassword" class="form-input" required>
                                
                                <div id="passwordRequirements" class="password-requirements">
                                    <h4>La contraseña debe contener:</h4>
                                    <div class="requirement" id="req-length">
                                        <div class="requirement-icon"></div><span>Mínimo 8 caracteres</span>
                                    </div>
                                    <div class="requirement" id="req-uppercase">
                                        <div class="requirement-icon"></div><span>Una mayúscula y una minúscula</span>
                                    </div>
                                    <div class="requirement" id="req-number">
                                        <div class="requirement-icon"></div><span>Un número y un carácter especial (@$!%*?&)</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mb-6">
                                <label class="form-label">Confirmar Nueva Contraseña</label>
                                <input type="password" id="confirmPassword" class="form-input" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Actualizar Contraseña</button>
                        </form>
                    </div>

                    <div id="tab-direcciones" class="profile-section">
                        <h2 class="text-xl font-bold mb-4">Mis Direcciones de Envío</h2>
                        <div class="p-4 bg-gray-50 rounded border border-gray-200 mb-4">
                            <p class="text-sm text-gray-600">Gestión de direcciones próximamente.</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>

    <script src="../assets/js/apiConfig.js"></script>
    <script src="../assets/js/authService.js"></script>
    <script src="../assets/js/main.js"></script>
    
    <script>
        // Lógica específica de Perfil
        document.addEventListener('DOMContentLoaded', async () => {
            if (!authService.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }
            await cargarDatosPerfil();
            setupPasswordValidation();
        });

        function setupPasswordValidation() {
            const input = document.getElementById('newPassword');
            const reqBox = document.getElementById('passwordRequirements');

            input.addEventListener('focus', () => reqBox.classList.add('active'));
            input.addEventListener('input', function() {
                const val = this.value;
                // Validar longitud (min 8)
                document.getElementById('req-length').classList.toggle('valid', val.length >= 8);
                // Validar Mayúscula y Minúscula
                const hasUpperLower = /[A-Z]/.test(val) && /[a-z]/.test(val);
                document.getElementById('req-uppercase').classList.toggle('valid', hasUpperLower);
                // Validar Número y Caracter Especial
                const hasNumSpecial = /[0-9]/.test(val) && /[@$!%*?&]/.test(val);
                document.getElementById('req-number').classList.toggle('valid', hasNumSpecial);
            });
        }

        function esPasswordValido(password) {
            const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
            return regex.test(password);
        }
        // --------------------------------------

        function showTab(tabName) {
            document.querySelectorAll('.profile-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            // Corrección: asegurar que event esté definido
            if(event && event.currentTarget) event.currentTarget.classList.add('active');
        }

        async function cargarDatosPerfil() {
            try {
                const perfil = await authService.getProfile();
                if (perfil) {
                    document.getElementById('nombre').value = perfil.nombre || '';
                    document.getElementById('apellido').value = perfil.apellido || '';
                    document.getElementById('email').value = perfil.email || '';
                    document.getElementById('telefono').value = perfil.telefono || '';
                    
                    if (perfil.fecha_registro) {
                        const fecha = new Date(perfil.fecha_registro).toLocaleDateString('es-PE', { year: 'numeric', month: 'long', day: 'numeric' });
                        document.getElementById('fechaRegistro').value = fecha;
                    }
                }
            } catch (error) {
                console.error(error);
                mostrarToast('Error al cargar perfil', 'error');
            }
        }

        async function actualizarPerfil(e) {
            e.preventDefault();
            const data = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                telefono: document.getElementById('telefono').value
            };
            
            try {
                await authService.updateProfile(data);
            } catch (error) {
                mostrarToast('Error al actualizar', 'error');
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.profile-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        async function cargarDatosPerfil() {
            try {
                const perfil = await authService.getProfile();
                if (perfil) {
                    document.getElementById('nombre').value = perfil.nombre || '';
                    document.getElementById('apellido').value = perfil.apellido || '';
                    document.getElementById('email').value = perfil.email || '';
                    document.getElementById('telefono').value = perfil.telefono || '';
                    
                    // Formatear fecha registro
                    if (perfil.fecha_registro) {
                        const fecha = new Date(perfil.fecha_registro).toLocaleDateString('es-PE', { year: 'numeric', month: 'long', day: 'numeric' });
                        document.getElementById('fechaRegistro').value = fecha;
                    }
                }
            } catch (error) {
                console.error(error);
                alert('Error al cargar perfil');
            }
        }

        async function actualizarPerfil(e) {
            e.preventDefault();
            const data = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                telefono: document.getElementById('telefono').value
            };
            
            try {
                await authService.updateProfile(data);
            } catch (error) {
                alert('Error al actualizar');
            }
        }

        async function cambiarPassword(e) {
            e.preventDefault();
            const current = document.getElementById('currentPassword').value;
            const newVal = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            // Validación de requisitos
            if (!esPasswordValido(newVal)) {
                mostrarToast('La contraseña no cumple con los requisitos de seguridad', 'warning');
                return;
            }

            if (newVal !== confirm) {
                mostrarToast('Las nuevas contraseñas no coinciden', 'warning');
                return;
            }

            try {
                await authService.changePassword(current, newVal);
                document.getElementById('formPassword').reset();
                // Resetear visualmente los requisitos
                document.querySelectorAll('.requirement').forEach(el => el.classList.remove('valid'));
                document.getElementById('passwordRequirements').classList.remove('active');
            } catch (error) {
                let msg = error.message || 'Error al cambiar contraseña';
                if (msg.includes(',')) msg = 'Datos inválidos o contraseña actual incorrecta';
                mostrarToast(msg, 'error');
            }
        }
    </script>
</body>
</html>
