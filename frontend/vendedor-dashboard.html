<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Vendedor - Sportiva</title>
    
    <link rel="stylesheet" href="assets/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root { --sidebar-width: 260px; --header-height: 70px; }
        body { background-color: #F9FAFB; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar {
            width: var(--sidebar-width); background: linear-gradient(180deg, #059669 0%, #047857 100%);
            color: white; position: fixed; height: 100vh; left: 0; top: 0; overflow-y: auto; z-index: 100;
        }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-logo { font-size: 24px; font-weight: 900; color: white; text-decoration: none; display: block; }
        .sidebar-menu { padding: 16px 0; }
        .menu-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 20px;
            color: #D1FAE5; text-decoration: none; transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent;
        }
        .menu-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background-color: rgba(255,255,255,0.15); color: white; border-left-color: #FCD34D; }
        .menu-icon { font-size: 20px; width: 24px; text-align: center; }
        .main-content { margin-left: var(--sidebar-width); flex: 1; min-height: 100vh; }
        .dashboard-header {
            height: var(--header-height); background: white; border-bottom: 1px solid #E5E7EB;
            display: flex; align-items: center; justify-content: space-between; padding: 0 32px; position: sticky; top: 0; z-index: 50;
        }
        .header-title { font-size: 24px; font-weight: 700; color: #111827; }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 8px 16px; background: #F0FDF4; border-radius: 8px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #10B981 0%, #059669 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
        .user-name { font-weight: 600; font-size: 14px; color: #111827; }
        .user-role { font-size: 12px; color: #059669; font-weight: 600; }
        .content-area { padding: 32px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .stat-card { background: white; padding: 24px; border-radius: 12px; border: 1px solid #E5E7EB; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
        .stat-icon { width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-icon.green { background: #F0FDF4; } .stat-icon.blue { background: #EFF6FF; }
        .stat-icon.yellow { background: #FFFBEB; } .stat-icon.red { background: #FEF2F2; }
        .stat-value { font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px; }
        .stat-label { font-size: 14px; color: #6B7280; font-weight: 500; }
        .stat-change { font-size: 13px; font-weight: 600; margin-top: 8px; }
        .stat-change.positive { color: #10B981; } .stat-change.negative { color: #EF4444; }
        .section-card { background: white; border-radius: 12px; border: 1px solid #E5E7EB; padding: 24px; margin-bottom: 24px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 18px; font-weight: 700; color: #111827; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table thead { background: #F9FAFB; }
        .data-table th { padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: #6B7280; text-transform: uppercase; }
        .data-table td { padding: 16px; border-top: 1px solid #E5E7EB; font-size: 14px; color: #374151; }
        .data-table tbody tr:hover { background: #F9FAFB; }
        .badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge.success { background: #D1FAE5; color: #065F46; }
        .badge.warning { background: #FEF3C7; color: #92400E; }
        .badge.danger { background: #FEE2E2; color: #991B1B; }
        .badge.info { background: #DBEAFE; color: #1E40AF; }
        .badge.purple { background: #EDE9FE; color: #6B21A8; }
        .btn-dashboard { padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #10B981; color: white; }
        .btn-primary:hover { background: #059669; }
        .btn-secondary { background: #F3F4F6; color: #374151; }
        .btn-secondary:hover { background: #E5E7EB; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .quick-action-card { background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; text-align: center; }
        .quick-action-card:hover { transform: translateY(-4px); }
        .quick-action-icon { font-size: 32px; margin-bottom: 8px; }
        .quick-action-title { font-weight: 600; font-size: 15px; }
        .alert { padding: 16px 20px; border-radius: 8px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
        .alert.info { background: #EFF6FF; color: #1E40AF; border: 1px solid #BFDBFE; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 700; color: #111827; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7280; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #E5E7EB; display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 8px; }
        .form-input, .form-select { width: 100%; padding: 12px 16px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 14px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #10B981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .form-input:read-only { background: #F9FAFB; color: #6B7280; }
        .filters-container { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { font-size: 14px; font-weight: 500; color: #6B7280; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; }
        .pagination button { padding: 8px 16px; border: 1px solid #D1D5DB; background: white; border-radius: 6px; cursor: pointer; }
        .pagination button:hover:not(:disabled) { background: #F3F4F6; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="sidebar-logo">SPORTIVA</a>
                <p style="font-size: 12px; color: #D1FAE5; margin-top: 4px;">Panel de Vendedor</p>
            </div>
            <nav class="sidebar-menu">
                <a href="#" class="menu-item active" onclick="showSection('dashboard')"><span class="menu-icon">üìä</span><span>Dashboard</span></a>
                <a href="#" class="menu-item" onclick="showSection('productos')"><span class="menu-icon">üì¶</span><span>Productos</span></a>
                <a href="#" class="menu-item" onclick="showSection('pedidos')"><span class="menu-icon">üõí</span><span>Pedidos</span></a>
                <div style="margin: 16px 0; height: 1px; background: rgba(255,255,255,0.2);"></div>
                <a href="index.html" class="menu-item"><span class="menu-icon">üè†</span><span>Ir a la Tienda</span></a>
                <a href="#" class="menu-item" onclick="cerrarSesion()"><span class="menu-icon">üö™</span><span>Cerrar Sesi√≥n</span></a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="dashboard-header">
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">V</div>
                    <div style="display: flex; flex-direction: column;">
                        <span class="user-name" id="userName">Vendedor</span>
                        <span class="user-role" id="userRole">Vendedor</span>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- DASHBOARD -->
                <div id="section-dashboard" class="content-section">
                    <div class="alert info">
                        <span style="font-size: 24px;">‚ÑπÔ∏è</span>
                        <div><strong>Permisos de Vendedor:</strong> Puedes gestionar productos, ver pedidos y actualizar inventario.</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-header"><div><div class="stat-value" id="statProductos">-</div><div class="stat-label">Productos Totales</div></div><div class="stat-icon green">üì¶</div></div><div class="stat-change positive">Activos en cat√°logo</div></div>
                        <div class="stat-card"><div class="stat-header"><div><div class="stat-value" id="statStock">-</div><div class="stat-label">Unidades en Stock</div></div><div class="stat-icon blue">üìä</div></div><div class="stat-change positive">Stock total disponible</div></div>
                        <div class="stat-card"><div class="stat-header"><div><div class="stat-value" id="statBajoStock">-</div><div class="stat-label">Productos Bajo Stock</div></div><div class="stat-icon yellow">‚ö†Ô∏è</div></div><div class="stat-change negative">Requieren reposici√≥n</div></div>
                        <div class="stat-card"><div class="stat-header"><div><div class="stat-value" id="statSinStock">-</div><div class="stat-label">Sin Stock</div></div><div class="stat-icon red">üî¥</div></div><div class="stat-change negative">Agotados</div></div>
                    </div>
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">Acciones R√°pidas</h3>
                    <div class="quick-actions">
                        <div class="quick-action-card" onclick="showSection('productos')"><div class="quick-action-icon">‚ûï</div><div class="quick-action-title">Ver Productos</div></div>
                        <div class="quick-action-card" onclick="showSection('pedidos')" style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);"><div class="quick-action-icon">üõí</div><div class="quick-action-title">Ver Pedidos</div></div>
                        <div class="quick-action-card" onclick="abrirModalInventario()" style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);"><div class="quick-action-icon">üìã</div><div class="quick-action-title">Gestionar Inventario</div></div>
                    </div>
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">‚ö†Ô∏è Productos con Bajo Stock / Sin Stock</h3><button class="btn-dashboard btn-secondary btn-sm" onclick="abrirModalInventario()">Ver Inventario</button></div>
                        <table class="data-table"><thead><tr><th>Producto</th><th>SKU</th><th>Stock Actual</th><th>Stock M√≠nimo</th><th>Estado</th><th>Acciones</th></tr></thead>
                        <tbody id="lowStockTable"><tr><td colspan="6" style="text-align: center; padding: 40px;">Cargando...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- PRODUCTOS -->
                <div id="section-productos" class="content-section" style="display: none;">
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">Gesti√≥n de Productos</h3></div>
                        <table class="data-table"><thead><tr><th>ID</th><th>Producto</th><th>Categor√≠a</th><th>Precio</th><th>Stock</th><th>Estado</th><th>Acciones</th></tr></thead>
                        <tbody id="productosTable"><tr><td colspan="7" style="text-align: center; padding: 40px;">Cargando...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- PEDIDOS -->
                <div id="section-pedidos" class="content-section" style="display: none;">
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">Gesti√≥n de Pedidos</h3></div>
                        <p style="color: #6B7280; margin-bottom: 24px;">Visualiza y gestiona los pedidos de la tienda.</p>
                        <div class="filters-container">
                            <div class="filter-group">
                                <label class="filter-label">Estado:</label>
                                <select class="form-select" id="filtroPedidoEstado" style="width: auto;" onchange="cambiarFiltroEstado()">
                                    <option value="">Todos</option>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Procesando">Procesando</option>
                                    <option value="Enviado">Enviado</option>
                                    <option value="Entregado">Entregado</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                            <button class="btn-dashboard btn-secondary btn-sm" onclick="cargarPedidos()">üîÑ Actualizar</button>
                        </div>
                        <table class="data-table"><thead><tr><th>N¬∞ Pedido</th><th>Cliente</th><th>Fecha</th><th>Total</th><th>Estado</th><th>Acciones</th></tr></thead>
                        <tbody id="pedidosTable"><tr><td colspan="6" style="text-align: center; padding: 40px;">Cargando...</td></tr></tbody></table>
                        <div class="pagination" id="pedidosPagination"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALES -->
    <div class="modal-overlay" id="modalInventario">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header"><h3 class="modal-title">üìã Gestionar Inventario</h3><button class="modal-close" onclick="cerrarModal('modalInventario')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><input type="text" class="form-input" id="buscarInventario" placeholder="üîç Buscar producto..." oninput="filtrarInventario()"></div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="data-table"><thead style="position: sticky; top: 0; background: white;"><tr><th>Producto</th><th>SKU</th><th>Stock</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="inventarioTable"></tbody></table>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-dashboard btn-secondary" onclick="cerrarModal('modalInventario')">Cerrar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalEditarStock">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header"><h3 class="modal-title">üì¶ Actualizar Stock</h3><button class="modal-close" onclick="cerrarModal('modalEditarStock')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Producto</label><input type="text" class="form-input" id="editStockProductoNombre" readonly></div>
                <div class="form-group"><label class="form-label">Talla</label><input type="text" class="form-input" id="editStockTalla" readonly></div>
                <div class="form-group"><label class="form-label">Stock Actual</label><input type="number" class="form-input" id="editStockCantidad" min="0"></div>
                <input type="hidden" id="editStockTallaId">
            </div>
            <div class="modal-footer">
                <button class="btn-dashboard btn-secondary" onclick="cerrarModal('modalEditarStock')">Cancelar</button>
                <button class="btn-dashboard btn-primary" onclick="guardarStock()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalDetallePedido">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header"><h3 class="modal-title">üìã Detalle del Pedido</h3><button class="modal-close" onclick="cerrarModal('modalDetallePedido')">&times;</button></div>
            <div class="modal-body" id="detallePedidoContent"></div>
            <div class="modal-footer"><button class="btn-dashboard btn-secondary" onclick="cerrarModal('modalDetallePedido')">Cerrar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalCambiarEstado">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header"><h3 class="modal-title">üîÑ Cambiar Estado</h3><button class="modal-close" onclick="cerrarModal('modalCambiarEstado')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Estado Actual</label><input type="text" class="form-input" id="estadoActualInput" readonly></div>
                <div class="form-group">
                    <label class="form-label">Nuevo Estado</label>
                    <select class="form-select" id="nuevoEstadoSelect">
                        <option value="">Seleccionar...</option>
                        <option value="Procesando">Procesando</option>
                        <option value="Enviado">Enviado</option>
                        <option value="Entregado">Entregado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <input type="hidden" id="pedidoIdCambiarEstado">
            </div>
            <div class="modal-footer">
                <button class="btn-dashboard btn-secondary" onclick="cerrarModal('modalCambiarEstado')">Cancelar</button>
                <button class="btn-dashboard btn-primary" onclick="confirmarCambioEstado()">‚úì Confirmar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalLogout">
        <div class="modal-content" style="max-width: 360px; text-align: center;">
            <div class="modal-body" style="padding: 32px 24px;">
                <div style="width: 64px; height: 64px; background: #FEF2F2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 28px;">
                    üö™
                </div>
                
                <h3 style="font-size: 20px; font-weight: 700; color: #111827; margin-bottom: 8px;">Cerrar Sesi√≥n</h3>
                <p style="color: #6B7280; font-size: 14px; margin-bottom: 24px; line-height: 1.5;">
                    ¬øEst√°s seguro de que deseas salir de tu cuenta?
                </p>
                
                <div style="display: flex; gap: 12px;">
                    <button class="btn-dashboard btn-secondary" onclick="cerrarModal('modalLogout')" style="flex: 1; justify-content: center;">
                        Cancelar
                    </button>
                    <button class="btn-dashboard btn-primary" onclick="confirmarLogout()" style="flex: 1; justify-content: center; background-color: #DC2626; color: white;">
                        S√≠, salir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast para notificaciones -->
    <div id="toastContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>

    <script src="assets/js/apiConfig.js"></script>
    <script src="assets/js/authService.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let todosLosProductos = [];
        let inventarioCompleto = [];
        let paginaActualPedidos = 1;

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        function mostrarToastLocal(mensaje, tipo = 'info') {
            const container = document.getElementById('toastContainer');
            const colors = { success: '#10B981', error: '#EF4444', warning: '#F59E0B', info: '#3B82F6' };
            const toast = document.createElement('div');
            toast.style.cssText = `background: ${colors[tipo] || colors.info}; color: white; padding: 12px 20px; border-radius: 8px; margin-top: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500;`;
            toast.textContent = mensaje;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Inicializando Panel de Vendedor...');
            const user = authService.getCurrentUser();
            if (!user) { window.location.href = 'login.html'; return; }
            if (user.rol !== 'Vendedor' && user.rol !== 'Administrador') { alert('No tienes permisos'); window.location.href = 'index.html'; return; }
            cargarDatosUsuario();
            const filtroEstado = document.getElementById('filtroPedidoEstado');
            if (filtroEstado) filtroEstado.value = "";
            await cargarEstadisticas();
            cargarProductosBajoStock();
            const section = document.querySelector('.content-section[style*="block"]');
            if(section && section.id === 'section-pedidos'){
                cargarPedidos();
          }
        });

        function cargarDatosUsuario() {
            const user = authService.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = `${user.nombre || ''} ${user.apellido || ''}`.trim() || user.email;
                document.getElementById('userRole').textContent = user.rol || 'Vendedor';
                document.getElementById('userAvatar').textContent = (user.nombre || user.email || 'V')[0].toUpperCase();
            }
        }

        // ============================================
        // ESTAD√çSTICAS
        // ============================================

        async function cargarEstadisticas() {
            try {
                console.log('Cargando estad√≠sticas...');
                let allProducts = [], page = 1, hasMore = true;

                // Cargar todas las p√°ginas de productos
                while (hasMore && page <= 10) {
                    const response = await apiGet(ENDPOINTS.PRODUCTOS.LISTAR, { limit: 100, page: page });
                    if (response.success && response.data?.productos) {
                        allProducts = allProducts.concat(response.data.productos);
                        hasMore = response.data.pagination && page < response.data.pagination.total_pages;
                        page++;
                    } else { hasMore = false; }
                }

                const productosActivos = allProducts.filter(p => p.estado_producto === 'Activo');
                todosLosProductos = productosActivos;

                let stockTotalGlobal = 0;
                let alertasBajoStock = 0;
                let alertasSinStock = 0;

                productosActivos.forEach(producto => {
                    const stockMinimo = producto.stock_minimo || 5;
                    
                    // Caso 1: Producto con tallas (Ropa, Calzado)
                    if (producto.tallas && producto.tallas.length > 0) {
                        let tieneAlgunaTallaBaja = false;
                        let tieneAlgunaTallaCero = false;

                        producto.tallas.forEach(t => {
                            const stockTalla = t.stock_talla || 0;
                            stockTotalGlobal += stockTalla;

                            // Evaluar cada talla individualmente
                            if (stockTalla === 0) {
                                tieneAlgunaTallaCero = true;
                            } else if (stockTalla <= stockMinimo) {
                                tieneAlgunaTallaBaja = true;
                            }
                        });

                        // Si alguna talla est√° en 0, cuenta para "Sin Stock"
                        if (tieneAlgunaTallaCero) alertasSinStock++;
                        
                        // Si hay tallas bajas (pero no 0), suma a bajo stock
                        if (tieneAlgunaTallaBaja) alertasBajoStock++;

                    } 
                    // Caso 2: Producto sin tallas (Accesorios, Balones)
                    else {
                        // Usamos stock_total que viene del backend o 0
                        const stockProducto = producto.stock_total || 0; 
                        stockTotalGlobal += stockProducto;

                        if (stockProducto === 0) {
                            alertasSinStock++;
                        } else if (stockProducto <= stockMinimo) {
                            alertasBajoStock++;
                        }
                    }
                });

                // Actualizar contadores en el Dashboard
                document.getElementById('statProductos').textContent = productosActivos.length;
                document.getElementById('statStock').textContent = stockTotalGlobal.toLocaleString();
                document.getElementById('statBajoStock').textContent = alertasBajoStock;
                document.getElementById('statSinStock').textContent = alertasSinStock;

                console.log(`Estad√≠sticas: ${productosActivos.length} prods, ${alertasSinStock} alertas sin stock, ${alertasBajoStock} alertas bajo stock`);
                
                // Recargar la tabla de alertas
                cargarProductosBajoStock(); 

            } catch (error) { console.error('Error cargando estad√≠sticas:', error); }
        }

        function cargarProductosBajoStock() {
            const tableBody = document.getElementById('lowStockTable');
            
            if (todosLosProductos.length === 0) { 
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px;">Cargando datos...</td></tr>`; 
                return; 
            }

            const alertas = [];

            todosLosProductos.forEach(producto => {
                const stockMinimo = producto.stock_minimo || 5;

                // Caso 1: Con Tallas
                if (producto.tallas && producto.tallas.length > 0) {
                    producto.tallas.forEach(t => {
                        const stock = t.stock_talla || 0;
                        // Si esta talla espec√≠fica tiene problemas, la agregamos a la lista
                        if (stock <= stockMinimo) {
                            alertas.push({
                                nombre: `${producto.nombre_producto} (Talla: ${t.talla})`, // Mostramos la talla
                                sku: producto.sku,
                                stockActual: stock,
                                stockMinimo: stockMinimo,
                                esSinStock: stock === 0,
                                id: producto.id_producto
                            });
                        }
                    });
                } 
                // Caso 2: Sin Tallas
                else {
                    const stock = producto.stock_total || 0;
                    if (stock <= stockMinimo) {
                        alertas.push({
                            nombre: producto.nombre_producto,
                            sku: producto.sku || 'N/A',
                            stockActual: stock,
                            stockMinimo: stockMinimo,
                            esSinStock: stock === 0,
                            id: producto.id_producto
                        });
                    }
                }
            });

            if (alertas.length === 0) { 
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #10B981;">‚úÖ Inventario saludable</td></tr>`; 
                return; 
            }
            alertas.sort((a, b) => a.stockActual - b.stockActual);

            tableBody.innerHTML = alertas.slice(0, 10).map(item => `
                <tr>
                    <td style="font-weight: 600;">${item.nombre}</td>
                    <td>${item.sku}</td>
                    <td style="font-weight: 600; color: ${item.esSinStock ? '#DC2626' : '#F59E0B'};">${item.stockActual}</td>
                    <td>${item.stockMinimo}</td>
                    <td><span class="badge ${item.esSinStock ? 'danger' : 'warning'}">${item.esSinStock ? 'Sin Stock' : 'Bajo Stock'}</span></td>
                    <td><button class="btn-dashboard btn-secondary btn-sm" onclick="abrirModalInventarioProducto(${item.id})">üì¶ Actualizar</button></td>
                </tr>
            `).join('');
        }

        // ============================================
        // NAVEGACI√ìN
        // ============================================
        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            const target = document.getElementById(`section-${sectionName}`);
            if (target) target.style.display = 'block';
            document.getElementById('pageTitle').textContent = { 'dashboard': 'Dashboard', 'productos': 'Productos', 'pedidos': 'Pedidos' }[sectionName] || 'Dashboard';
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.menu-item[onclick*="${sectionName}"]`)?.classList.add('active');
            if (sectionName === 'pedidos') cargarPedidos();
            else if (sectionName === 'productos') cargarProductosTabla();
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Inicializando Panel de Vendedor...');
            const user = authService.getCurrentUser();
            if (!user) { window.location.href = 'login.html'; return; }

            cargarDatosUsuario();
            const filtroEstado = document.getElementById('filtroPedidoEstado');
            if (filtroEstado) filtroEstado.value = ""; 
            
            await cargarEstadisticas();
            cargarProductosBajoStock();
            
            const section = document.querySelector('.content-section[style*="block"]');
            if(section && section.id === 'section-pedidos'){
                cargarPedidos();
            }
        });

        // ============================================
        // NUEVA FUNCI√ìN PARA MANEJAR EL CAMBIO DE FILTRO
        // ============================================
        function cambiarFiltroEstado() {
            paginaActualPedidos = 1;
            cargarPedidos();
        }

        // ============================================
        // FUNCI√ìN CARGAR PEDIDOS CORREGIDA
        // ============================================
        async function cargarPedidos() {
            const tableBody = document.getElementById('pedidosTable');
            const estadoFiltro = document.getElementById('filtroPedidoEstado').value;
            
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px;">Cargando pedidos...</td></tr>`;
            
            try {
                const params = { page: paginaActualPedidos, limit: 10 };

                if (estadoFiltro) params.estado = estadoFiltro; 
                
                console.log('Llamando a endpoint pedidos con params:', params);
                
                const response = await apiGet('/pedidos/vendedor/list', params);
                
                if (response.success && response.data?.pedidos) {
                    const pedidos = response.data.pedidos;
                    
                    if (pedidos.length === 0) { 
                        tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px;">No se encontraron pedidos</td></tr>`; 

                        const pagContainer = document.getElementById('pedidosPagination');
                        if(pagContainer) pagContainer.innerHTML = '';
                        return; 
                    }
                    
                    tableBody.innerHTML = pedidos.map(pedido => {
                        const fecha = pedido.fecha_pedido ? new Date(pedido.fecha_pedido).toLocaleDateString('es-PE') : 'N/A';
                        const total = parseFloat(pedido.total_pedido || 0).toFixed(2);
                        const estado = pedido.estado_pedido || 'Pendiente';
                        
                        return `
                            <tr>
                                <td style="font-weight: 600;">${pedido.numero_pedido || 'N/A'}</td>
                                <td>${pedido.cliente_nombre || 'Cliente'}</td>
                                <td>${fecha}</td>
                                <td style="font-weight: 600;">S/ ${total}</td>
                                <td><span class="badge ${getBadgeClass(estado)}">${estado}</span></td>
                                <td>
                                    <button class="btn-dashboard btn-secondary btn-sm" onclick="verDetallePedido(${pedido.id_pedido})" title="Ver detalle">üëÅÔ∏è</button>
                                    <button class="btn-dashboard btn-secondary btn-sm" onclick="abrirModalCambiarEstado(${pedido.id_pedido}, '${estado}')" title="Cambiar estado">üîÑ</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    if (response.data.pagination) renderizarPaginacion(response.data.pagination);
                    
                } else { 
                    throw new Error(response.message || 'Error al cargar pedidos'); 
                }
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #DC2626; padding: 40px;">Error: ${error.message}</td></tr>`;
            }
        }

        function getBadgeClass(estado) {
            return { 'Pendiente': 'warning', 'Procesando': 'info', 'Enviado': 'purple', 'Entregado': 'success', 'Cancelado': 'danger' }[estado] || 'info';
        }

        async function verDetallePedido(idPedido) {
            const modal = document.getElementById('modalDetallePedido');
            const content = document.getElementById('detallePedidoContent');
            modal.classList.add('active');
            content.innerHTML = '<p style="text-align: center; padding: 40px;">Cargando...</p>';
            try {
                const response = await apiGet(`/pedidos/vendedor/${idPedido}`);
                console.log('Detalle pedido response:', response);
                if (response.success && response.data) {
                    const p = response.data.pedido || response.data;
                    const fecha = p.fecha_pedido ? new Date(p.fecha_pedido).toLocaleDateString('es-PE', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                    const estado = p.estado_pedido || p.estado || 'Pendiente';
                    const clienteNombre = p.cliente_nombre ? `${p.cliente_nombre} ${p.cliente_apellido || ''}`.trim() : 'N/A';
                    const items = p.items || p.detalles || [];
                    const total = parseFloat(p.total_pedido || p.total || 0).toFixed(2);
                    
                    content.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                            <div><p style="color: #6B7280; font-size: 13px; margin-bottom: 4px;">N¬∞ Pedido</p><p style="font-weight: 600; font-size: 16px;">${p.numero_pedido || 'N/A'}</p></div>
                            <div><p style="color: #6B7280; font-size: 13px; margin-bottom: 4px;">Fecha</p><p style="font-weight: 600;">${fecha}</p></div>
                            <div><p style="color: #6B7280; font-size: 13px; margin-bottom: 4px;">Cliente</p><p style="font-weight: 600;">${clienteNombre}</p></div>
                            <div><p style="color: #6B7280; font-size: 13px; margin-bottom: 4px;">Estado</p><span class="badge ${getBadgeClass(estado)}">${estado}</span></div>
                        </div>
                        <h4 style="font-weight: 600; margin-bottom: 12px; font-size: 16px;">Productos</h4>
                        <table class="data-table">
                            <thead><tr><th>Producto</th><th>Talla</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr></thead>
                            <tbody>
                                ${items.length > 0 ? items.map(item => `
                                    <tr>
                                        <td>${item.nombre_producto || 'Producto'}</td>
                                        <td>${item.talla || '√öNICA'}</td>
                                        <td>${item.cantidad}</td>
                                        <td>S/ ${parseFloat(item.precio_unitario || 0).toFixed(2)}</td>
                                        <td>S/ ${parseFloat(item.subtotal || 0).toFixed(2)}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5" style="text-align: center;">Sin productos</td></tr>'}
                            </tbody>
                        </table>
                        <div style="text-align: right; border-top: 1px solid #E5E7EB; padding-top: 16px; margin-top: 16px;">
                            ${p.subtotal ? `<p style="color: #6B7280;">Subtotal: S/ ${parseFloat(p.subtotal).toFixed(2)}</p>` : ''}
                            ${p.costo_envio ? `<p style="color: #6B7280;">Env√≠o: S/ ${parseFloat(p.costo_envio).toFixed(2)}</p>` : ''}
                            ${p.igv ? `<p style="color: #6B7280;">IGV: S/ ${parseFloat(p.igv).toFixed(2)}</p>` : ''}
                            <p style="font-size: 20px; font-weight: 700; color: #10B981; margin-top: 8px;">Total: S/ ${total}</p>
                        </div>
                    `;
                } else { throw new Error(response.message || 'Error al obtener detalle'); }
            } catch (error) {
                console.error('Error en detalle:', error);
                content.innerHTML = `<p style="color: #DC2626; text-align: center; padding: 40px;">Error: ${error.message}</p>`;
            }
        }

        function abrirModalCambiarEstado(idPedido, estadoActual) {
            document.getElementById('pedidoIdCambiarEstado').value = idPedido;
            document.getElementById('estadoActualInput').value = estadoActual;
            document.getElementById('nuevoEstadoSelect').value = '';
            document.getElementById('modalCambiarEstado').classList.add('active');
        }

        async function confirmarCambioEstado() {
            const idPedido = document.getElementById('pedidoIdCambiarEstado').value;
            const nuevoEstado = document.getElementById('nuevoEstadoSelect').value;
            
            if (!nuevoEstado) {
                mostrarToastLocal('Selecciona un nuevo estado', 'warning');
                return;
            }
            
            try {
                const response = await apiPatch(`/pedidos/vendedor/${idPedido}/estado`, { 
                    nuevo_estado: nuevoEstado 
                });
                
                if (response.success) {
                    mostrarToastLocal('Estado actualizado correctamente', 'success');
                    cerrarModal('modalCambiarEstado');
                    cargarPedidos();
                } else {
                    throw new Error(response.message || 'Error al cambiar estado');
                }
            } catch (error) {
                console.error('Error cambiando estado:', error);
                mostrarToastLocal('Error: ' + error.message, 'error');
            }
        }

        function renderizarPaginacion(pagination) {
            const container = document.getElementById('pedidosPagination');
            if (!container || !pagination) return;
            const totalPages = pagination.total_pages || Math.ceil(pagination.total / pagination.limit) || 1;
            container.innerHTML = `
                <button onclick="cambiarPaginaPedidos(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''}>‚Üê Anterior</button>
                <span style="padding: 8px 16px; color: #6B7280;">P√°gina ${pagination.page} de ${totalPages}</span>
                <button onclick="cambiarPaginaPedidos(${pagination.page + 1})" ${pagination.page >= totalPages ? 'disabled' : ''}>Siguiente ‚Üí</button>
            `;
        }

        function cambiarPaginaPedidos(nuevaPagina) { paginaActualPedidos = nuevaPagina; cargarPedidos(); }

        // ============================================
        // PRODUCTOS
        // ============================================

        async function cargarProductosTabla() {
            const tableBody = document.getElementById('productosTable');
            
            if (todosLosProductos.length === 0) await cargarEstadisticas();
            
            if (todosLosProductos.length === 0) { 
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px;">No hay productos</td></tr>`; 
                return; 
            }

            tableBody.innerHTML = todosLosProductos.map(p => {
                let stock = 0;
                if (p.tallas) p.tallas.forEach(t => stock += t.stock_talla || 0);
                const categoriaNombre = p.categoria?.nombre_categoria || p.nombre_categoria || 'Sin categor√≠a';

                return `
                    <tr>
                        <td>${p.id_producto}</td>
                        <td style="font-weight: 600;">${p.nombre_producto}</td>
                        <td>${categoriaNombre}</td>
                        <td>S/ ${parseFloat(p.precio).toFixed(2)}</td>
                        <td style="font-weight: 600; color: ${stock === 0 ? '#DC2626' : '#10B981'};">${stock}</td>
                        <td><span class="badge ${p.estado_producto === 'Activo' ? 'success' : 'danger'}">${p.estado_producto}</span></td>
                        <td><button class="btn-dashboard btn-secondary btn-sm" onclick="abrirModalInventarioProducto(${p.id_producto})">üì¶</button></td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // INVENTARIO
        // ============================================
        async function abrirModalInventario() {
            document.getElementById('modalInventario').classList.add('active');
            await cargarInventario();
        }

        async function cargarInventario() {
            if (todosLosProductos.length === 0) await cargarEstadisticas();
            inventarioCompleto = [];
            todosLosProductos.forEach(producto => {
                if (producto.tallas?.length) {
                    producto.tallas.forEach(talla => {
                        inventarioCompleto.push({
                            id_producto: producto.id_producto,
                            nombre_producto: producto.nombre_producto,
                            sku: producto.sku || 'N/A',
                            id_talla: talla.id_talla,
                            talla: talla.talla,
                            stock_talla: talla.stock_talla || 0
                        });
                    });
                }
            });
            renderizarInventario(inventarioCompleto);
        }

        function renderizarInventario(items) {
            const tableBody = document.getElementById('inventarioTable');
            if (items.length === 0) { tableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 40px;">No hay productos</td></tr>`; return; }
            tableBody.innerHTML = items.map(item => `
                <tr>
                    <td><div style="font-weight: 600;">${item.nombre_producto}</div><div style="font-size: 12px; color: #6B7280;">Talla: ${item.talla}</div></td>
                    <td>${item.sku}</td>
                    <td style="font-weight: 600; color: ${item.stock_talla === 0 ? '#DC2626' : item.stock_talla <= 5 ? '#F59E0B' : '#10B981'};">${item.stock_talla}</td>
                    <td><button class="btn-dashboard btn-secondary btn-sm" onclick="abrirModalEditarStock(${item.id_talla}, '${item.nombre_producto.replace(/'/g, "\\'")}', '${item.talla}', ${item.stock_talla})">‚úèÔ∏è</button></td>
                </tr>
            `).join('');
        }

        function filtrarInventario() {
            const busqueda = document.getElementById('buscarInventario').value.toLowerCase();
            renderizarInventario(inventarioCompleto.filter(i => i.nombre_producto.toLowerCase().includes(busqueda) || i.sku.toLowerCase().includes(busqueda)));
        }

        function abrirModalEditarStock(idTalla, nombre, talla, stock) {
            document.getElementById('editStockTallaId').value = idTalla;
            document.getElementById('editStockProductoNombre').value = nombre;
            document.getElementById('editStockTalla').value = talla;
            document.getElementById('editStockCantidad').value = stock;
            document.getElementById('modalEditarStock').classList.add('active');
        }

        async function guardarStock() {
            const idTalla = document.getElementById('editStockTallaId').value;
            const nuevoStock = parseInt(document.getElementById('editStockCantidad').value);
            if (isNaN(nuevoStock) || nuevoStock < 0) { mostrarToastLocal('Stock inv√°lido', 'warning'); return; }
            try {
                const response = await apiPatch(`/productos/tallas/${idTalla}/stock`, { stock_talla: nuevoStock });
                if (response.success) {
                    mostrarToastLocal('Stock actualizado', 'success');
                    cerrarModal('modalEditarStock');
                    todosLosProductos = [];
                    await cargarEstadisticas();
                    cargarProductosBajoStock();
                    await cargarInventario();
                } else { throw new Error(response.message); }
            } catch (error) { mostrarToastLocal('Error: ' + error.message, 'error'); }
        }

        async function abrirModalInventarioProducto(idProducto) {
            await abrirModalInventario();
            const producto = todosLosProductos.find(p => p.id_producto === idProducto);
            if (producto) { document.getElementById('buscarInventario').value = producto.nombre_producto; filtrarInventario(); }
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function cerrarModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
        function cerrarSesion() {
            document.getElementById('modalLogout').classList.add('active');
        }

        async function confirmarLogout() {
            const btn = event.currentTarget;
            btn.innerHTML = 'Saliendo...';
            btn.disabled = true;

            await authService.logout();
        }

        // ============================================
        // MANEJO DEL CAMBIO DE FILTRO
        // ============================================
        function cambiarFiltroEstado() {
            paginaActualPedidos = 1;
            cargarPedidos();
        }
    </script>
</body>
</html>
